





# 05. Docker


Docker 包括三个基本概念:
 - 镜像（Image）：Docker 镜像（Image），就相当于是一个 root 文件系统。比如官方镜像 ubuntu:16.04 就包含了完整的一套 Ubuntu16.04 最小系统的 root 文件系统。
 - 容器（Container）：镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。
 - 仓库（Repository）：仓库可看成一个代码控制中心，用来保存镜像。


三个docker核心技术:
 - namespace: 命名空间是Linux内核的一项功能，该功能对内核资源进行分区，使一组进程看到一组资源，而另一组进程看到另一组资源。
 - cgroups: 默认情况，所有Docker容器可以平等地使用宿主机资源并且没有限制。cgroups是一种Linux内核功能，可限制和隔离进程集合的资源使用情况（CPU，内存，磁盘io，网络等），被LXC、docker等很多项目用于实现进程资源控制。Linux使用文件系统来实现 cgroups。
 - rootfs: Linux系统中的根文件系统，Root FileSystem，简称为根文件系统rootfs；根文件系统是包含在与根目录相同的分区上的文件系统，是内核启动时所mount的第一个文件系统，内核代码映像文件保存在根文件系统中，而系统引导启动程序会在根文件系统挂载之后, 把初始化脚本和服务等加载到内存中运行。Docker 支持不同的存储驱动，包括 aufs、devicemapper、overlay2、zfs 和 vfs 等，在最新的 Docker 中，overlay2 取代了 aufs 成为了推荐的存储驱动。


nvidia docker 容器中devel、runtime、base三种文件的区别：
 - base： 该版本是从cuda9.0开始，包含了部署预构建cuda应用程序的最低限度（libcudart）。如果用户需要自己安装自己需要的cuda包，可以选择使用这个image版本，但如果想省事儿，则不建议使用该image，会多出许多麻烦。
 - runtime： 该版本通过添加cuda工具包中的所有共享库开扩展基本image。如果使用多个cuda库的预构建应用程序，可使用此image。但是如果想借助cuda中的头文件对自己的工程进行编译，则会出现找不到文件的错误。
 - devel： 通过添加编译器工具链，测试工具，头文件和静态库来扩展运行的image，使用此图像可以从源代码编译cuda应用程序。



## 1 docker pull（拉镜像）
```shell
sudo docker pull  paddlehub.com/paddle:0.11.0-gpu   % 拉docker镜像
sudo docker images                               % 显示所有docker镜像

sudo docker pull  nvidia/cuda:8.0-cudnn7-devel
```

## 2 docker run（运行容器）
```shell
# ==== v1
docker run -it -d --name=test_paddle \
--device=/dev/nvidia0:/dev/nvidia0 \
--device=/dev/nvidia1:/dev/nvidia1 \
--device=/dev/nvidia2:/dev/nvidia2 \
--device=/dev/nvidia3:/dev/nvidia3 \
--device=/dev/nvidia4:/dev/nvidia4 \
--device=/dev/nvidia5:/dev/nvidia5 \
--device=/dev/nvidia6:/dev/nvidia6 \
--device=/dev/nvidia7:/dev/nvidia7 \
--device=/dev/nvidiactl:/dev/nvidiactl \
--device=/dev/nvidia-uvm:/dev/nvidia-uvm \
-v /data/dmcvcache:/root/.cache:rw \
-v /data/cv/logs/:/root/.cache/logs \
-v /data/aidata:/data \
-v /data1/aidata:/data1 \
-v /usr/lib/nvidia-docker/volumes/nvidia_driver/375.26:/usr/local/nvidia \
-v /etc/localtime:/etc/localtime:ro \
-p 18307:9096 \
-p 18217:226 \
docker.paddlepaddlehub.com/paddle:0.11.0-gpu /bin/bash –D
```
编写上面的脚本，保存为startdocker.sh，运行。
    配置项里有对应的设备，存储空间，端口号和docker容器(REPOSITORY和TAG)，用(netstat -tunlp)查看未使用的端口号
    如果想从服务镜像中恢复原来的环境，而不启动工程则加上--entrypoint=bash

```shell
# ==== v2
sudo nvidia-docker run -it -d  --net=host  --name=cs_ddm --privileged=true --shm-size=8G \
--device=/dev/nvidia0:/dev/nvidia0 \
--device=/dev/nvidia0:/dev/nvidia0 \
--device=/dev/nvidia0:/dev/nvidia0 \
--device=/dev/nvidia0:/dev/nvidia0 \
--device=/dev/nvidiactl:/dev/nvidiactl \
--device=/dev/nvidia-uvm:/dev/nvidia-uvm \
-v /data/home:/data/home \
-v /data3:/data3 \
-v /usr/lib/nvidia-docker/volumes/nvidia_driver/driver:/usr/local/nvidia \
 thub.autohome.com.cn/dm_ai/cs_images:ddm  /bin/bash -D
```


```shell
# ==== v3
sudo docker run -it -d --net=host --name=cs_torch --privileged=true --shm-size=8G \
 -v /dev:/dev \
 -v /data1:/data1 \
 -v /data2:/data2 \
 -v /imagecenter:/imagecenter \
 10.196.3.6:5000/registry.vivo.lan/library/centos:centos7.4.1708-v1.1-20200217-tf1.14-v1.052_ffmpeg-20200622-py3_torch_gcc5.2-20200813
```


## 3 docker exec（进入容器）
```shell
sudo  docker  ps  -a                        % 显示所有docker容器
sudo  docker  exec  -it  2f9aebc64ffe  bash       % 运行docker容器（2f9aebc64ffe）
Ctrl-D或  exit                      % 退出容器

## 4 docker commit（封装容器为镜像）
sudo docker  commit  96621f37028c  deepspeech2    % 将容器ID（96621f37028c）打包成镜像（deepspeech2）

注意：
docker commit  不能把之前docker 的 -v 映射路径 导入到新的docker。 需要重新映射
```

## 5 docker rm/rmi（删除容器和镜像）
```shell
sudo docker  stop 30321a197b16
sudo docker  rm  fb087642b497           % 删除运行的容器（fb087642b497）
sudo docker  rmi 1363775b74ef              % 删除运行的镜像（1363775b74ef ）

**删除 镜像时报错：**
image has dependent child images
**解决方法：**
删除镜像名，不要删除镜像ID
```


```shell

docker system prune    # 删除无用镜像


# 停止docker
docker stop $(docker ps -a | grep "Exited" | awk '{print $1 }')
# 删除docker
docker rm $(docker ps -a | grep "Exited" | awk '{print $1 }')
# 删除images
docker rmi $(docker images | grep "none" | awk '{print $3}') 
//前面两步是为了删除该镜像实例化的container,不然删除不掉Image

```




## 6 docker rename (重命名容器名) 、docker tag（重命名镜像名）

```shell
# ==== rename
docker rename 原容器名  新容器名

# ==== tag
docker tag  997d44cd505a  cuda8_chensong:0_11_0_gpu   # 更改镜像ID（997d44cd505a）的REPOSITORY 和 TAG
```






## 7 docker push（推镜像）

```shell
（1）登录镜像仓库
sudo docker login thub.autohome.com.cn    % 登录镜像仓库，输入OA密码
（sudo docker logout thub.autohome.com.cn   % 退出登录的镜像仓库）

（2）镜像名字更改为指定镜像库地址
sudo docker tag  997d44cd505a  thub.autohome.com.cn/dm_ai/paddle_cuda8:0_11_0_gpu   % 更改镜像ID（997d44cd505a）的REPOSITORY 和 TAG

（3）push
sudo  docker push  thub.autohome.com.cn/dm_ai/paddle_cuda8:0_11_0_gpu   % 推镜像
```

## 8 Dockerfile
（1）编写Dockerfile
```shell

FROM nvidia/cudagl:11.3.0-devel-ubuntu18.04

RUN sed -i "s/archive.ubuntu./mirrors.aliyun./g" /etc/apt/sources.list
RUN sed -i "s/security.ubuntu./mirrors.aliyun./g" /etc/apt/sources.list
RUN sed -i "s/deb.debian.org/mirrors.aliyun.com/g" /etc/apt/sources.list
RUN sed -i "s/security.debian.org/mirrors.aliyun.com\/debian-security/g" /etc/apt/sources.list

    RUN rm /etc/apt/sources.list.d/*

COPY ffmpeg-build   /build/ffmpeg

ADD http://download.dl.bdp.autohome.com.cn/dltrain/krb5.conf /etc/
RUN apt-get update && apt-get install --no-install-recommends -y \
    openjdk-8-jre-headless \
    krb5-user \
    wget \
    unzip \
    libgtk2.0-0 && \
    apt-get clean all && \
    rm -rf /var/lib/apt/lists/*
```

（2）运行
```shell
sudo docker build -t images_cs:0_11_0_gpu  .   
```


## 9 image ==> dockerfile

```shell
# Command alias
echo "alias image2df='docker run -v /var/run/docker.sock:/var/run/docker.sock --rm cucker/image2df'" >> ~/.bashrc
. ~/.bashrc

# 执行 image2df
image2df thub.autohome.com.cn/dm_ai/u16.04-cuda9.0-cudnn7-devel_cs:ffmpeg_gpu_basev1 > Dockerfile
```



### 10 image《==》.tar
docker save -o  yolov5.tar ultralytics/yolov5:latest            镜像打包成文件
docker load < yolov5.tar            导入文件为镜像
docker load --input  yolov5.tar           同上




## 20 docker 重启

```shell
systemctl  daemon-reload
systemctl  restart  docker.service 

```

如果 start 之前的docker 失败，提示  Error response from daemon: OCI runtime create failed: container with id exists: 244a1531ede27d37afcaf0e6ef56d180f4e0a4d7e5da9b0d0067f68924360f03: unknown  。 
解决方法： 用root 账号 到  /var/run/docker/runtime-nvidia/moby/ 把对应的 id 文件夹删掉就行


## x 其他
```shell
docker image history   
docker inspect             获取容器/镜像的元数据
```



docker 直接使用宿主机cuda ： 
咨询过，这个方法不好。
https://blog.csdn.net/weixin_35775446/article/details/113537369 （还没成功）







